/*!
 *  CanvasInput v1.0.0
 *  http://goldfirestudios.com/blog/108/CanvasInput-HTML5-Canvas-Text-Input
 *
 *  (c) 2013, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */

(function(){var a=[],b=window.CanvasInput=function(d){var c=this;d=d?d:{},c._canvas=d.canvas||null,c._ctx=c._canvas?c._canvas.getContext("2d"):null,c._x=d.x||0,c._y=d.y||0,c._extraX=d.extraX||0,c._extraY=d.extraY||0,c._fontSize=d.fontSize||14,c._fontFamily=d.fontFamily||"Arial",c._fontColor=d.fontColor||"#000",c._placeHolderColor=d.placeHolderColor||"#bfbebd",c._fontWeight=d.fontWeight||"normal",c._fontStyle=d.fontStyle||"normal",c._readonly=d.readonly||!1,c._width=d.width||150,c._height=d.height||c._fontSize,c._padding=d.padding>=0?d.padding:5,c._borderWidth=d.borderWidth>=0?d.borderWidth:1,c._borderColor=d.borderColor||"#959595",c._borderRadius=d.borderRadius>=0?d.borderRadius:3,c._backgroundImage=d.backgroundImage||"",c._boxShadow=d.boxShadow||"1px 1px 0px rgba(255, 255, 255, 1)",c._innerShadow=d.innerShadow||"0px 0px 4px rgba(0, 0, 0, 0.4)",c._selectionColor=d.selectionColor||"rgba(179, 212, 253, 0.8)",c._placeHolder=d.placeHolder||"",c._value=d.value||c._placeHolder,c._onsubmit=d.onsubmit||function(){},c._onkeydown=d.onkeydown||function(){},c._onkeyup=d.onkeyup||function(){},c._cursor=!1,c._cursorPos=0,c._hasFocus=!1,c._selection=[0,0],c._wasOver=!1,c.boxShadow(c._boxShadow,!0),c._calcWH(),c._renderCanvas=document.createElement("canvas"),c._renderCanvas.setAttribute("width",c.outerW),c._renderCanvas.setAttribute("height",c.outerH),c._renderCtx=c._renderCanvas.getContext("2d"),c._shadowCanvas=document.createElement("canvas"),c._shadowCanvas.setAttribute("width",c._width+c._padding*2),c._shadowCanvas.setAttribute("height",c._height+c._padding*2),c._shadowCtx=c._shadowCanvas.getContext("2d"),typeof d.backgroundGradient!="undefined"?(c._backgroundColor=c._renderCtx.createLinearGradient(0,0,0,c.outerH),c._backgroundColor.addColorStop(0,d.backgroundGradient[0]),c._backgroundColor.addColorStop(1,d.backgroundGradient[1])):c._backgroundColor=d.backgroundColor||"#fff",c._canvas&&(c._canvas.addEventListener("mousemove",function(f){f=f||window.event,c.mousemove(f,c)},!1),c._canvas.addEventListener("mousedown",function(f){f=f||window.event,c.mousedown(f,c)},!1),c._canvas.addEventListener("mouseup",function(f){f=f||window.event,c.mouseup(f,c)},!1)),window.addEventListener("keydown",function(f){f=f||window.event,c._hasFocus&&c.keydown(f,c)}),window.addEventListener("keyup",function(f){f=f||window.event,c._hasFocus&&c._onkeyup(f,c)}),window.addEventListener("paste",function(g){if(g=g||window.event,c._hasFocus){var h=g.clipboardData.getData("text/plain"),f=c._value.substr(0,c._cursorPos),i=c._value.substr(c._cursorPos);c._value=f+h+i,c._cursorPos+=h.length,c.render()}}),a.push(c),c._inputsIndex=a.length-1,c.render()};b.prototype={canvas:function(c){var d=this;return c!==void 0?(d._canvas=c,d._ctx=d._canvas.getContext("2d"),d.render()):d._canvas},x:function(c){var d=this;return c!==void 0?(d._x=c,d.render()):d._x},y:function(c){var d=this;return c!==void 0?(d._y=c,d.render()):d._y},extraX:function(c){var d=this;return c!==void 0?(d._extraX=c,d.render()):d._extraX},extraY:function(c){var d=this;return c!==void 0?(d._extraY=c,d.render()):d._extraY},fontSize:function(c){var d=this;return c!==void 0?(d._fontSize=c,d.render()):d._fontSize},fontFamily:function(c){var d=this;return c!==void 0?(d._fontFamily=c,d.render()):d._fontFamily},fontColor:function(c){var d=this;return c!==void 0?(d._fontColor=c,d.render()):d._fontColor},placeHolderColor:function(c){var d=this;return c!==void 0?(d._placeHolderColor=c,d.render()):d._placeHolderColor},fontWeight:function(c){var d=this;return c!==void 0?(d._fontWeight=c,d.render()):d._fontWeight},fontStyle:function(c){var d=this;return c!==void 0?(d._fontStyle=c,d.render()):d._fontStyle},width:function(c){var d=this;return c!==void 0?(d._width=c,d._calcWH(),d.render()):d._width},height:function(c){var d=this;return c!==void 0?(d._height=c,d._calcWH(),d.render()):d._height},padding:function(c){var d=this;return c!==void 0?(d._padding=c,d._calcWH(),d.render()):d._padding},borderWidth:function(c){var d=this;return c!==void 0?(d._borderWidth=c,d._calcWH(),d.render()):d._borderWidth},borderColor:function(c){var d=this;return c!==void 0?(d._borderColor=c,d.render()):d._borderColor},borderRadius:function(c){var d=this;return c!==void 0?(d._borderRadius=c,d.render()):d._borderRadius},backgroundColor:function(c){var d=this;return c!==void 0?(d._backgroundColor=c,d.render()):d._backgroundColor},backgroundGradient:function(c){var d=this;return c!==void 0?(d._backgroundColor=d._renderCtx.createLinearGradient(0,0,0,d.outerH),d._backgroundColor.addColorStop(0,c[0]),d._backgroundColor.addColorStop(1,c[1]),d.render()):d._backgroundColor},boxShadow:function(f,g){var d=this;if(void 0===f){return d._boxShadow}var c=f.split("px ");return d._boxShadow={x:d._boxShadow==="none"?0:parseInt(c[0],10),y:d._boxShadow==="none"?0:parseInt(c[1],10),blur:d._boxShadow==="none"?0:parseInt(c[2],10),color:d._boxShadow==="none"?"":c[3]},d._boxShadow.x<0?(d.shadowL=Math.abs(d._boxShadow.x)+d._boxShadow.blur,d.shadowR=d._boxShadow.blur+d._boxShadow.x):(d.shadowL=Math.abs(d._boxShadow.blur-d._boxShadow.x),d.shadowR=d._boxShadow.blur+d._boxShadow.x),d._boxShadow.y<0?(d.shadowT=Math.abs(d._boxShadow.y)+d._boxShadow.blur,d.shadowB=d._boxShadow.blur+d._boxShadow.y):(d.shadowT=Math.abs(d._boxShadow.blur-d._boxShadow.y),d.shadowB=d._boxShadow.blur+d._boxShadow.y),d.shadowW=d.shadowL+d.shadowR,d.shadowH=d.shadowT+d.shadowB,d._calcWH(),g?void 0:d.render()},innerShadow:function(c){var d=this;return c!==void 0?(d._innerShadow=c,d.render()):d._innerShadow},selectionColor:function(c){var d=this;return c!==void 0?(d._selectionColor=c,d.render()):d._selectionColor},placeHolder:function(c){var d=this;return c!==void 0?(d._placeHolder=c,d.render()):d._placeHolder},value:function(c){var d=this;return c!==void 0?(d._value=c,d.render()):d._value},onsubmit:function(c){var d=this;return c!==void 0?(d._onsubmit=c,d):(d._onsubmit(),void 0)},onkeydown:function(c){var d=this;return c!==void 0?(d._onkeydown=c,d):(d._onkeydown(),void 0)},onkeyup:function(c){var d=this;return c!==void 0?(d._onkeyup=c,d):(d._onkeyup(),void 0)},focus:function(f){var g,d=this;if(!d._readonly){d._selectionUpdated?delete d._selectionUpdated:d._selection=[0,0],d._cursorPos="number"==typeof f?f:d._clipText().length,d._placeHolder===d._value&&(d._value=""),d._hasFocus=!0,d._cursor=!0,d._cursorInterval&&clearInterval(d._cursorInterval),d._cursorInterval=setInterval(function(){d._cursor=!d._cursor,d.render()},500);var c=typeof window.orientation!="undefined";return c&&document&&document.createElement&&(g=document.createElement("input"))?(g.type="test",g.style.opacity=0,g.style.position="absolute",g.style.top=d._x+d._extraX+"px",g.style.left=d._y+d._extraY+"px",g.style.width=g.style.height=0,document.body.appendChild(g),g.focus(),g.addEventListener("blur",function(){d.blur(d)},!1)):c&&d.value(prompt(d._placeHolder)||""),d.render()}},blur:function(c){var d=c||this;return d._cursorInterval&&clearInterval(d._cursorInterval),d._hasFocus=!1,d._cursor=!1,d._selection=[0,0],d._value===""&&(d._value=d._placeHolder),d.render()},keydown:function(k,h){var f,l,c=k.which,j=k.shiftKey,e=null;if(h._hasFocus){if(h._onkeydown(k,h),65===c&&(k.ctrlKey||k.metaKey)){return h._selection=[0,h._value.length],k.preventDefault(),h.render()}if(17===c||k.metaKey||k.ctrlKey){return h}if(k.preventDefault(),8===c){h._clearSelection()||h._cursorPos>0&&(f=h._value.substr(0,h._cursorPos-1),l=h._value.substr(h._cursorPos,h._value.length),h._value=f+l,h._cursorPos--)}else{if(37===c){h._cursorPos>0&&(h._cursorPos--,h._cursor=!0,h._selection=[0,0])}else{if(39===c){h._cursorPos<h._value.length&&(h._cursorPos++,h._cursor=!0,h._selection=[0,0])}else{if(13===c){h._onsubmit(k,h)}else{if(9===c){var g=a[h._inputsIndex+1]?h._inputsIndex+1:0;h.blur(),setTimeout(function(){a[g].focus()},10)}else{(e=h._mapCodeToKey(j,c))&&(h._clearSelection(),f=h._value.substr(0,h._cursorPos),l=h._value.substr(h._cursorPos),h._value=f+e+l,h._cursorPos++)}}}}}return h.render()}},click:function(f,g){var d=f.offsetX||f.clientX,c=f.offsetY||f.clientY;return g._endSelection?(delete g._endSelection,delete g._selectionUpdated,void 0):g._canvas&&g._overInput(d,c)||!g._canvas?g._mouseDown?(g._mouseDown=!1,g.click(f,g),g.focus(g._clickPos(d,c))):void 0:g.blur()},mousemove:function(j,l){var h=j.offsetX||j.clientX,g=j.offsetY||j.clientY,m=l._overInput(h,g);if(m&&l._canvas?(l._canvas.style.cursor="text",l._wasOver=!0):l._wasOver&&l._canvas&&(l._canvas.style.cursor="default",l._wasOver=!1),l._hasFocus&&l._selectionStart>=0){var c=l._clickPos(h,g),k=Math.min(l._selectionStart,c),f=Math.max(l._selectionStart,c);if(!m){return l._selectionUpdated=!0,l._endSelection=!0,delete l._selectionStart,l.render(),void 0}(l._selection[0]!==k||l._selection[1]!==f)&&(l._selection=[k,f],l.render())}},mousedown:function(f,g){var d=f.offsetX||f.clientX,c=f.offsetY||f.clientY,h=g._overInput(d,c);g._mouseDown=h,g._hasFocus&&h&&(g._selectionStart=g._clickPos(d,c))},mouseup:function(f,g){var d=f.offsetX||f.clientX,c=f.offsetY||f.clientY,h=g._clickPos(d,c)!==g._selectionStart;g._hasFocus&&g._selectionStart>=0&&g._overInput(d,c)&&h?(g._selectionUpdated=!0,delete g._selectionStart,g.render()):delete g._selectionStart,g.click(f,g)},renderCanvas:function(){return this._renderCanvas},render:function(){var j=this,l=j._renderCtx,h=j.outerW,g=j.outerH,m=j._borderRadius,c=j._borderWidth,k=j.shadowW,f=j.shadowH;l.clearRect(0,0,l.canvas.width,l.canvas.height),l.shadowOffsetX=j._boxShadow.x,l.shadowOffsetY=j._boxShadow.y,l.shadowBlur=j._boxShadow.blur,l.shadowColor=j._boxShadow.color,j._borderWidth>0&&(l.fillStyle=j._borderColor,j._roundedRect(l,j.shadowL,j.shadowT,h-k,g-f,m),l.fill(),l.shadowOffsetX=0,l.shadowOffsetY=0,l.shadowBlur=0),j._drawTextBox(function(){l.shadowOffsetX=0,l.shadowOffsetY=0,l.shadowBlur=0;var F=j._clipText(),C=j._padding+j._borderWidth+j.shadowT;if(j._selection[1]>0){var e=j._textWidth(F.substring(0,j._selection[0])),E=j._textWidth(F.substring(j._selection[0],j._selection[1]));l.fillStyle=j._selectionColor,l.fillRect(C+e,C,E,j._height)}if(l.fillStyle=j._placeHolder===j._value&&j._value!==""?j._placeHolderColor:j._fontColor,j._cursor){var r=j._textWidth(F.substring(0,j._cursorPos));l.fillRect(C+r,C,1,j._height)}var n=j._padding+j._borderWidth+j.shadowL,q=Math.round(C+j._height/2);l.font=j._fontStyle+" "+j._fontWeight+" "+j._fontSize+"px "+j._fontFamily,l.textAlign="left",l.textBaseline="middle",l.fillText(F,n,q);var D=j._innerShadow.split("px "),B=j._innerShadow==="none"?0:parseInt(D[0],10),z=j._innerShadow==="none"?0:parseInt(D[1],10),A=j._innerShadow==="none"?0:parseInt(D[2],10),d=j._innerShadow==="none"?"":D[3];if(A>0){var o=j._shadowCtx,i=o.canvas.width,t=o.canvas.height;o.clearRect(0,0,i,t),o.shadowBlur=A,o.shadowColor=d,o.shadowOffsetX=0,o.shadowOffsetY=z,o.fillRect(-1*h,-100,3*h,100),o.shadowOffsetX=B,o.shadowOffsetY=0,o.fillRect(i,-1*g,100,3*g),o.shadowOffsetX=0,o.shadowOffsetY=z,o.fillRect(-1*h,t,3*h,100),o.shadowOffsetX=B,o.shadowOffsetY=0,o.fillRect(-100,-1*g,100,3*g),j._roundedRect(l,c+j.shadowL,c+j.shadowT,h-2*c-k,g-2*c-f,m),l.clip(),l.drawImage(j._shadowCanvas,0,0,i,t,c+j.shadowL,c+j.shadowT,i,t)}return j._ctx&&(j._ctx.clearRect(j._x,j._y,l.canvas.width,l.canvas.height),j._ctx.drawImage(j._renderCanvas,j._x,j._y)),j})},_drawTextBox:function(j){var f=this,c=f._renderCtx,p=f.outerW,g=f.outerH,l=f._borderRadius,k=f._borderWidth,h=f.shadowW,q=f.shadowH;if(f._backgroundImage===""){c.fillStyle=f._backgroundColor,f._roundedRect(c,k+f.shadowL,k+f.shadowT,p-2*k-h,g-2*k-q,l),c.fill(),j()}else{var m=new Image;m.src=f._backgroundImage,m.onload=function(){c.drawImage(m,0,0,m.width,m.height,k+f.shadowL,k+f.shadowT,p,g),delete m,j()}}},_clearSelection:function(){var d=this;if(d._selection[1]>0){var f=d._selection[0],c=d._selection[1];return d._value=d._value.substr(0,f)+d._value.substr(c),d._cursorPos=f,d._cursorPos=d._cursorPos<0?0:d._cursorPos,d._selection=[0,0],!0}return !1},_clipText:function(){var f=this,g=f._textWidth(f._value),d=g/(f._width-f._padding),c=d>1?f._value.substr(-1*Math.floor(f._value.length/d)):f._value;return c},_textWidth:function(d){var f=this,c=f._renderCtx;return c.font=f._fontStyle+" "+f._fontWeight+" "+f._fontSize+"px "+f._fontFamily,c.textAlign="left",c.measureText(d).width},_calcWH:function(){var c=this;c.outerW=c._width+c._padding*2+c._borderWidth*2+c.shadowW,c.outerH=c._height+c._padding*2+c._borderWidth*2+c.shadowH},_roundedRect:function(g,h,f,d,i,c){2*c>d&&(c=d/2),2*c>i&&(c=i/2),g.beginPath(),g.moveTo(h+c,f),g.arcTo(h+d,f,h+d,f+i,c),g.arcTo(h+d,f+i,h,f+i,c),g.arcTo(h,f+i,h,f,c),g.arcTo(h,f,h+d,f,c),g.closePath()},_overInput:function(h,j){var g=this,f=h>=g._x+g._extraX,k=h<=g._x+g._extraX+g._width+g._padding*2,c=j>=g._y+g._extraY,i=j<=g._y+g._extraY+g._height+g._padding*2;return f&&k&&c&&i},_clickPos:function(g){var h=this,f=h._clipText(h._value),d=0,i=f.length;if(g-(h._x+h._extraX)<h._textWidth(f)){for(var c=0;c<f.length;c++){if(d+=h._textWidth(f[c]),d>=g-(h._x+h._extraX)){i=c;break}}}return i},_mapCodeToKey:function(g,h){for(var f=[8,9,13,16,17,18,20,27,91,92],d="",i=0;i<f.length;i++){if(h===f[i]){return}}if("boolean"==typeof g&&"number"==typeof h){var c={32:" ",48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",107:"+",189:"_",186:":",187:"+",188:"<",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'};return d=g?h>=65&&90>=h?String.fromCharCode(h):c[h]:h>=65&&90>=h?String.fromCharCode(h).toLowerCase():188===h?",":190===h?".":191===h?"/":192===h?"`":220===h?"\\":187===h?"=":189===h?"-":222===h?"'":186===h?";":219===h?"[":221===h?"]":String.fromCharCode(h)}}}})();